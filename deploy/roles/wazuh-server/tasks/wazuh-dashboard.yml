---
- name: Install Wazuh dashboard prerequisites
  ansible.builtin.apt:
    name:
      - gnupg
      - apt-transport-https
      - software-properties-common
      - wget
    state: present

- name: Install Wazuh dashboard
  ansible.builtin.apt:
    name: wazuh-dashboard={{ wazuh_version }}-*
    state: present
  notify: restart wazuh-dashboard

- name: Configure Wazuh dashboard network binding
  ansible.builtin.lineinfile:
    path: /etc/wazuh-dashboard/opensearch_dashboards.yml
    regexp: "^server.host:"
    line: "server.host: \"{{ wazuh_dashboard_server_host }}\""
    backup: yes
  notify: restart wazuh-dashboard

- name: Configure Wazuh dashboard port
  ansible.builtin.lineinfile:
    path: /etc/wazuh-dashboard/opensearch_dashboards.yml
    regexp: "^server.port:"
    line: "server.port: {{ wazuh_dashboard_server_port }}"
    backup: yes
  notify: restart wazuh-dashboard

- name: Configure Wazuh dashboard to connect to indexer
  ansible.builtin.lineinfile:
    path: /etc/wazuh-dashboard/opensearch_dashboards.yml
    regexp: "^opensearch.hosts:"
    line: "opensearch.hosts: [\"https://{{ ansible_default_ipv4.address }}:9200\"]"
    backup: yes
  notify: restart wazuh-dashboard

- name: Enable and start Wazuh dashboard
  ansible.builtin.systemd:
    name: wazuh-dashboard
    enabled: yes
    state: started
    daemon_reload: yes

- name: Wait for Wazuh dashboard to be ready
  ansible.builtin.wait_for:
    port: "{{ wazuh_dashboard_server_port }}"
    host: 127.0.0.1
    delay: 10
    timeout: 300